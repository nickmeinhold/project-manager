name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  claude-code-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude Code Action
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          show_full_output: true
          prompt: |
            You are reviewing PR #${{ github.event.pull_request.number }} in ${{ github.repository }}.

            ## Project Context
            An intelligent project management system with:
            - **Backend**: Firebase Functions (TypeScript)
            - **Web**: React + TypeScript
            - **Mobile**: Flutter (Dart)
            - **Database**: Firebase Firestore
            - **Notifications**: Firebase Cloud Messaging

            ## Review Process
            1. Run `gh pr diff ${{ github.event.pull_request.number }}` to see the changes
            2. Read relevant files for full context when needed
            3. Collect all inline comments, then submit as a single review with:
               ```
               gh api repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/reviews \
                 -f commit_id="$(gh pr view ${{ github.event.pull_request.number }} --json headRefOid -q .headRefOid)" \
                 -f event="REQUEST_CHANGES" \
                 -f body="Summary of review" \
                 -f comments='[{"path":"file.ts","line":10,"body":"Comment 1"},{"path":"file.ts","line":20,"body":"Comment 2"}]'
               ```
               Use event="APPROVE" if no issues, "REQUEST_CHANGES" for blocking issues, "COMMENT" for suggestions only.

            ## Review Criteria

            **Must Fix (request changes):**
            - Security vulnerabilities (injection, auth bypass, secrets in code)
            - Firebase security rules that expose data
            - Data loss or corruption risks
            - Breaking changes to APIs without migration path
            - Unhandled errors that would crash the service

            **Should Fix (comment):**
            - Missing error handling for edge cases
            - Performance issues (N+1 queries, unnecessary re-renders)
            - Type safety gaps (any types, missing null checks)
            - Missing input validation
            - Firestore query inefficiencies

            **Consider (optional suggestions):**
            - Code style and readability improvements
            - Minor refactoring opportunities
            - Test coverage gaps

            ## Review Guidelines
            - Be specific: reference file names and line numbers
            - Explain *why* something is an issue, not just *what*
            - Suggest concrete fixes when possible
            - Acknowledge what's done well (briefly)
            - Don't nitpick formatting if there's a linter

            ## Submit Review
            Submit your review using the gh api command in step 3 above. The review MUST include:
            - All inline comments bundled in the `comments` array
            - A summary in the `body` field
            - The appropriate `event`: "APPROVE", "REQUEST_CHANGES", or "COMMENT"
          claude_args: |
            --allowedTools "Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh api repos/*/pulls/*/reviews:*),Bash(gh api repos/*/issues/*:*),Read,Glob,Grep"
